# Example ModSecurity Configuration for TechGear Pro
# This is a sample configuration showing common rules that might trigger false positives

# Include OWASP Core Rule Set base configuration
# Include @owasp_crs/*.conf

# ============================================
# Common False Positive Scenarios
# ============================================

# Rule 942100 - SQL Injection Attack Detected via libinjection
# TRIGGERS ON: Product searches like "O'Reilly's", "SELECT * FROM"
# RECOMMENDATION: Add exception for /shop/ and search parameters

SecRule REQUEST_URI "@beginsWith /shop/" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=942150,\
    msg:'Disable SQLi rules for shop search'"

SecRule REQUEST_URI "@rx \/\?s=" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    msg:'Disable SQLi rules for WordPress search'"

# Rule 941100 - XSS Attack Detected
# TRIGGERS ON: Comments with HTML/XML like "<configuration>", form submissions
# RECOMMENDATION: Add exception for comment and contact form submissions

SecRule REQUEST_URI "@contains /wp-comments-post.php" \
    "id:1003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    msg:'Disable XSS rules for WordPress comments'"

SecRule REQUEST_URI "@contains /wp-admin/admin-ajax.php" \
    "id:1004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    msg:'Disable XSS rules for AJAX requests'"

# Rule 930100 - Path Traversal Attack
# TRIGGERS ON: Legitimate paths like /wp-content/plugins/, error messages with paths
# RECOMMENDATION: Allow WordPress standard paths

SecRule REQUEST_URI "@beginsWith /wp-content/" \
    "id:1005,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=930100,\
    ctl:ruleRemoveById=930110,\
    msg:'Allow WordPress content directory access'"

SecRule REQUEST_URI "@beginsWith /wp-includes/" \
    "id:1006,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=930100,\
    ctl:ruleRemoveById=930110,\
    msg:'Allow WordPress includes directory access'"

# Rule 920430 - HTTP protocol version is not allowed
# TRIGGERS ON: Old browsers or specific clients
# RECOMMENDATION: Allow HTTP/1.0 and HTTP/1.1

SecRule REQUEST_PROTOCOL "!@rx ^HTTP/(1\.0|1\.1|2\.0)$" \
    "id:1007,\
    phase:1,\
    deny,\
    status:400,\
    msg:'Invalid HTTP protocol version'"

# ============================================
# Rate Limiting Configuration
# ============================================

# Moderate rate limiting for legitimate traffic
# 60 requests per minute per IP for most pages
SecAction \
    "id:1100,\
    phase:1,\
    nolog,\
    pass,\
    initcol:ip=%{REMOTE_ADDR},\
    setvar:ip.requests=+1,\
    expirevar:ip.requests=60"

SecRule IP:REQUESTS "@gt 60" \
    "id:1101,\
    phase:1,\
    deny,\
    status:429,\
    msg:'Rate limit exceeded: 60 requests/minute',\
    log"

# Higher rate limit for REST API endpoints (for logged-in users)
SecRule REQUEST_URI "@beginsWith /wp-json/" \
    "id:1102,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=1101"

# ============================================
# File Upload Restrictions
# ============================================

# Allow specific file types for WooCommerce and Contact Forms
SecRule FILES "@rx \.(jpg|jpeg|png|gif|pdf|txt|log|xml|json)$" \
    "id:1200,\
    phase:2,\
    pass,\
    nolog,\
    msg:'Allow legitimate file uploads'"

# Block executable files
SecRule FILES "@rx \.(php|phtml|php3|php4|php5|php7|phps|cgi|pl|py|sh|exe|dll)$" \
    "id:1201,\
    phase:2,\
    deny,\
    status:403,\
    msg:'Blocked executable file upload',\
    log"

# ============================================
# WooCommerce Specific Rules
# ============================================

# Allow WooCommerce checkout process
SecRule REQUEST_URI "@beginsWith /checkout/" \
    "id:1300,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=941100,\
    msg:'Allow WooCommerce checkout'"

# Allow cart operations
SecRule REQUEST_URI "@contains /?wc-ajax=" \
    "id:1301,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    msg:'Allow WooCommerce AJAX cart operations'"

# ============================================
# WordPress Admin Area
# ============================================

# More lenient rules for authenticated admin users
# NOTE: In production, you'd verify authentication here
SecRule REQUEST_URI "@beginsWith /wp-admin/" \
    "id:1400,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=930100,\
    msg:'Relax rules for WordPress admin area'"

# ============================================
# Known WordPress Endpoints
# ============================================

# Block XML-RPC if not needed (common attack vector)
# UNCOMMENT to enable blocking:
# SecRule REQUEST_URI "@streq /xmlrpc.php" \
#     "id:1500,\
#     phase:1,\
#     deny,\
#     status:403,\
#     msg:'XML-RPC access blocked',\
#     log"

# ============================================
# Training Exercise Configuration
# ============================================

# For training purposes, log all rule matches without blocking
# REMOVE in production environment!

# Audit log configuration
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsec_audit.log

# Debug logging (disable in production)
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 3

# ============================================
# Response Header
# ============================================

# Add custom header to identify WAF
SecRule REQUEST_URI "@unconditionalMatch" \
    "id:1900,\
    phase:3,\
    pass,\
    nolog,\
    setvar:tx.waf_header=TechGearWAF/1.0"

Header always set X-WAF-Status "Protected by TechGearWAF"

# ============================================
# Notes for Training
# ============================================

# Common False Positive Patterns to Test:
#
# 1. Product Searches:
#    - "O'Reilly's Gaming Mouse" (apostrophe)
#    - "15\" MacBook Pro" (quotes)
#    - "SELECT your size" (SQL keyword)
#
# 2. Contact Forms:
#    - Error messages with SQL-like content
#    - Configuration snippets with XML tags
#    - File paths in support requests
#
# 3. Comments:
#    - Technical discussions with code
#    - IP addresses and server references
#    - Special characters in natural language
#
# 4. Admin Operations:
#    - Bulk product editing
#    - Plugin configuration with complex data
#    - Theme customization with CSS/JS
#
# Tuning Process:
# 1. Enable DetectionOnly mode initially
# 2. Collect logs from legitimate traffic
# 3. Identify false positive patterns
# 4. Create targeted exceptions (like above)
# 5. Test exceptions don't weaken security
# 6. Enable blocking mode
# 7. Monitor and iterate
